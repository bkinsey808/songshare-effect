# Supabase Client Token Authentication System

## Overview

The Supabase client token system provides authenticated access to RLS-protected data using a shared visitor user account. This allows anonymous users to read public data while maintaining proper Supabase authentication.

## How Supabase Client Tokens Work

1. **Server-side Generation**: A Supabase client token is a real Supabase JWT generated by signing in a shared visitor user using the service key
2. **Client-side Caching**: The token is cached in memory to avoid repeated API calls
3. **Automatic Refresh**: When the token expires, a new one is automatically fetched
4. **RLS Compatibility**: The token includes a `visitor_id` claim that works with Row Level Security policies

## Required Environment Variables

### Frontend (.env.local)

```bash
# Supabase Configuration
VITE_SUPABASE_URL=your-supabase-project-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key  # Required to initialize client

# API Configuration
VITE_API_BASE_URL=http://localhost:8787
```

**Note**: `VITE_SUPABASE_ANON_KEY` is required to initialize the Supabase client. The visitor JWT is then used to override the anon permissions via the Authorization header.

### Backend (Cloudflare Workers environment)

```bash
# Supabase Configuration
VITE_SUPABASE_URL=your-supabase-project-url
SUPABASE_SERVICE_KEY=your-service-key

# Visitor User Credentials
SUPABASE_VISITOR_EMAIL=visitor@yourdomain.com
SUPABASE_VISITOR_PASSWORD=secure-visitor-password
```

## Setup Instructions

### 1. Create a Visitor User in Supabase

1. Go to your Supabase project dashboard
2. Navigate to Authentication > Users
3. Create a new user with the email/password you'll use in your environment variables
4. Note the user ID - this will be used for the `visitor_id` claim

### 2. Configure RLS Policies

Your RLS policies should check for the `visitor_id` claim:

```sql
-- Example policy for public song data
CREATE POLICY "Visitor can read public songs" ON song_public
  FOR SELECT
  TO authenticated
  USING (auth.jwt() ->> 'visitor_id' IS NOT NULL);
```

### 3. Usage in React Components

```typescript
import { getSupabaseClientWithAuth } from './supabaseClient';

const MyComponent = () => {
  const [songs, setSongs] = useState([]);

  useEffect(() => {
    const loadSongs = async () => {
      const client = await getSupabaseClientWithAuth();
      if (client) {
        const { data } = await client.from('song_public').select('*');
        setSongs(data || []);
      }
    };
    loadSongs();
  }, []);

  return <div>{/* render songs */}</div>;
};
```

## API Endpoints

- **GET** `/api/auth/visitor` - Returns a Supabase client JWT token for visitor access
  - Response: `{ access_token: string, token_type: "bearer", expires_in: number }`
  - The `access_token` is a Supabase JWT that can be used for client-side operations

## Token Flow

1. **First Visit**: No cached token → API call → Generate Supabase client token → Cache in memory
2. **Subsequent Visits**: Check memory cache → Use cached token if valid → API call only if expired
3. **Token Expiry**: Automatic refresh when token expires or is about to expire

## Debugging

Use the `clearSupabaseClientToken()` function to clear the cached token for testing:

```typescript
import { clearSupabaseClientToken } from "./services/auth";

// Clear token to force refresh
clearSupabaseClientToken();
```
