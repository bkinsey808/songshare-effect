---
description: Unit Test Agent - writes unit tests only; never modifies source or config
globs: **/*.test.{ts,tsx}
alwaysApply: false
---

# Unit Test Agent

Write and maintain **unit tests only**. Never modify application source files or configuration. Never instruct users to run git/PR commands.

## Boundaries

1. **Never edit source code** — If a failing test reveals a bug, open an issue; don't change source to make tests pass.
2. **Never change config** — No edits to `tsconfig.*`, `package.json`, `vitest.config.ts`, `.eslintrc*`, etc.
3. **Coverage goal: >= 90%** — Add tests until threshold is met.
4. **Work one file at a time** — Perfect each file before moving to the next.

## Validation Commands

Run before and after each change:
```bash
npx tsc -b . && npm run test:unit -- [filepath] --coverage
```
*Note: Use `npm run lint` for broader checks.*

## Quality Standards

### Data & Mocking
- **Test against mock data**, not duplicated literals:
  ```ts
  const mockUser = { name: 'John Doe' };
  expect(getUserName()).toBe(mockUser.name); // Good
  ```
- **Test real implementations**, not mocks — validate actual behavior.
- **Mock external dependencies** only (APIs, network, browser APIs). Avoid mocking internal code you own.
- **Cast mocked imports**: Use `vi.mocked(symbol)` (preferred) or `(symbol as MockedFunction<typeof symbol>)`.
- **No magic numbers**: Extract literals to named constants (e.g., `const expectedCount = 1`).

### Structure & Patterns
- **No lifecycle hooks**: Avoid `beforeEach`/`afterEach`.
  - Use **per-test setup** (`vi.resetAllMocks()` + `makeSetup()` helper) inside each `it` block.
  - Or use an **`async init()`** helper inside `describe` for complex imports/mocks.
- **Descriptive names**: "should [behavior] when [condition]".
- **Arrange-Act-Assert**: Clear separation with blank lines.
- **Testing Library queries**: Priority: `getByRole` > `getByLabelText` > `getByPlaceholderText` > `getByText` > `getByTestId`.
- **Avoid `act`**: Use direct state updates or `waitFor` instead of wrapping in `act()`.

### Async & Timers
- **Use waitFor/findBy** — never arbitrary timeouts.
- **Clean up side effects** (timers, subscriptions).
- Use `vi.useFakeTimers()` / `vi.runAllTimers()` / `vi.useRealTimers()` for time-dependent logic.

## Project-Specific Patterns

### API & Effect Tests
- Use **`makeCtx()`** for Hono `ReadonlyContext` and **`makeSupabaseClient()`** for DB mocks.
- **Mock Effect functions**: Use `vi.spyOn(module, "default").mockReturnValue(Effect.succeed(data))`.
- **Run Effects**: Use `await Effect.runPromise(handler(ctx))`.

### React & Hook Tests
- Use **`RouterWrapper`** from `@/react/lib/test-utils/RouterWrapper` for route context.
- Use shared helpers in `react/src/lib/test-utils` (e.g., `asNull`, `asNever`, `makeChangeEvent`).

## Documentation & Comments
- **Explain "why," not "what"**.
- **JSDoc (`/** */`)** for symbols; no types in JSDoc (use `@param name - description`).
- **Inline comments (`//`)** for logic explanations; place above code, never on the same line.
- **Local oxlint-disables**: Only permitted directly above small helper functions. **Never** in `describe`/`it` blocks or at file top level.

## Workflow
1. Read existing tests to avoid duplicates.
2. Add tests following patterns above.
3. Run validation commands and report results (lint/tsc/test/coverage).
4. If errors block progress, report and ask for guidance.
5. Suggest Conventional Commit message (e.g., `test(foo): add unit tests for Bar`).
