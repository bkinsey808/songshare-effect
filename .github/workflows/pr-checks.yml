name: PR Checks (lint, unit, functions-dist, smoke-e2e)

# Test workflow trigger - added for testing
# Avoid duplicate work for rapid pushes against the same PR branch
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions: # least privilege by default
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint-and-unit:
    name: Lint and Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [20]
    permissions:
      contents: read
      checks: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # one Set run display title step kept above

      # Set run display title removed — no dynamic renaming

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create reports directory
        run: mkdir -p reports

      - name: Lint
        run: |
          # Run the project's lint script and fail the job if lint errors are present.
          npm run lint

      # Lint diagnostics removed; workflow cleaned up

      - name: Unit tests (with coverage)
        run: npm run test:unit -- --coverage

      - name: Upload unit test results (JUnit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-junit
          path: reports/unit-junit.xml

      - name: Publish JUnit test report to GitHub Checks
        # Only attempt to create check run annotations when the PR head repo is the same repository
        # (if PRs are from forks, the GITHUB_TOKEN often lacks sufficient permissions and the action fails).
        if: always() && (github.event.pull_request.head.repo.full_name == github.repository)
        uses: dorny/test-reporter@v1
        with:
          name: Unit Tests Results
          path: reports/unit-junit.xml
          reporter: java-junit
          fail-on-empty: false
          # Do not fail the job if the reporter runs into a permission issue or other reporter errors
          fail-on-error: false

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage

  check-functions-dist:
    name: Prepare & check functions dist
    runs-on: ubuntu-latest
    needs: lint-and-unit
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set run display title removed — no dynamic renaming

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Bun runtime (installer with retries)
        run: |
          set -euxo pipefail

          # Use bun's official installer directly and retry a few times to guard against
          # transient CDN / HTTP failures that previously caused the job to fail.
          for i in 1 2 3; do
            echo "bun installer attempt $i"
            if curl -fsSL https://bun.sh/install | bash -s --; then
              BUN_INSTALL="${HOME}/.bun"
              # Make bun available in the current shell and in later steps. The
              # installer appends PATH to ~/.bash_profile; export it now and
              # source the profile so bun is usable immediately.
              export BUN_INSTALL
              export PATH="${BUN_INSTALL}/bin:${PATH}"
              if [ -f "${HOME}/.bash_profile" ]; then
                # shellcheck disable=SC1090
                source "${HOME}/.bash_profile" || true
              fi
              echo "BUN_INSTALL=${BUN_INSTALL}" >> $GITHUB_ENV
              echo "PATH=${BUN_INSTALL}/bin:${PATH}" >> $GITHUB_ENV
              echo "bun installed: $(command -v bun || true) $(bun --version 2>/dev/null || true)"
              break
            else
              echo "installer attempt $i failed; retrying in 3s"
              sleep 3
            fi
          done

          if ! command -v bun >/dev/null 2>&1; then
            echo "bun is still not available after retries" >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run prepare-functions
        run: bun run scripts/build/prepare-functions/prepare-functions.ts

      - name: Validate dist/functions imports
        run: npm run check:functions-dist-imports

  smoke-e2e:
    name: PR smoke end-to-end (Playwright)
    runs-on: ubuntu-latest
    needs: lint-and-unit
    permissions:
      contents: read
    concurrency:
      group: smoke-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set run display title removed — no dynamic renaming

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build frontend (client only for fast smoke)
        run: npm run build:client

      - name: Start preview server
        run: |
          # Bind the preview server explicitly to IPv4 localhost so wait-on can reach it
          nohup npm run preview -- --host 127.0.0.1 --port 5173 > preview.log 2>&1 &
          echo $! > preview.pid
          # start in background and save pid
          echo "preview started (background)"

      - name: Run smoke Playwright tests (http or https)
        run: |
          # try http first, then https. whichever responds first will be used as the base URL
          # Add a timeout to wait-on so we don't hang indefinitely if the preview fails to start.
          WAIT_ON_TIMEOUT_MS=180000
          # Check localhost first since Vite prints Local: http://localhost:5173/
          if npx wait-on -t "$WAIT_ON_TIMEOUT_MS" http://localhost:5173; then
            echo "preview available at http://localhost:5173"
            PLAYWRIGHT_BASE_URL=http://localhost:5173 npx playwright test e2e/render.e2e.ts --project=chromium --reporter=list,junit --workers=1 --timeout=30000 || true
          elif npx wait-on -t "$WAIT_ON_TIMEOUT_MS" http://127.0.0.1:5173; then
            echo "preview available at http://127.0.0.1:5173"
            PLAYWRIGHT_BASE_URL=http://127.0.0.1:5173 npx playwright test e2e/render.e2e.ts --project=chromium --reporter=list,junit --workers=1 --timeout=30000 || true
          else
            echo "Preview did not become available (neither http://localhost:5173 nor http://127.0.0.1:5173) after ${WAIT_ON_TIMEOUT_MS}ms" >&2
            echo "Preview did not become available after ${WAIT_ON_TIMEOUT_MS}ms" >&2
            exit 1
          fi

      - name: Upload Playwright report (smoke)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-report
          path: playwright-report

      - name: Upload preview log (smoke)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-log-smoke
          path: preview.log
