name: ${{ github.event_name == 'pull_request' && format('%s — %s', github.workflow, github.event.pull_request.title) || format('%s — %s', github.workflow, replace(github.ref, 'refs/heads/', '')) }}

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    # Restrict PR runs to changes which affect functions/packaging or build scripts.
    paths:
      - "api/**"
      - "shared/**"
      - "scripts/build/prepare-functions/**"
      - "scripts/**"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.json"

concurrency:
  group: functions-dist-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check-functions-dist:
    name: Prepare & validate functions bundle
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set run display title
        if: always()
        run: |
          DISPLAY_TITLE="${{ github.workflow }} — ${{ github.event.pull_request.title || github.head_ref || github.ref_name || github.sha }}"
          curl -s -X PATCH \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -d "{\"display_title\":\"${DISPLAY_TITLE}\"}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Bun (installer with retries)
        run: |
          set -euxo pipefail

          for i in 1 2 3; do
            echo "bun installer attempt $i"
            if curl -fsSL https://bun.sh/install | bash -s --; then
              BUN_INSTALL="${HOME}/.bun"
              # Make bun available in the current shell and in later steps. The
              # installer writes PATH to ~/.bash_profile but that won't affect the
              # running shell until sourced, so export to the current shell first
              # and also persist values to $GITHUB_ENV for subsequent steps.
              export BUN_INSTALL
              export PATH="${BUN_INSTALL}/bin:${PATH}"
              # In some runner environments the installer only appends PATH to
              # the profile — source it to ensure the binary is discoverable.
              if [ -f "${HOME}/.bash_profile" ]; then
                # shellcheck disable=SC1090
                source "${HOME}/.bash_profile" || true
              fi
              echo "BUN_INSTALL=${BUN_INSTALL}" >> $GITHUB_ENV
              echo "PATH=${BUN_INSTALL}/bin:${PATH}" >> $GITHUB_ENV
              echo "bun installed: $(command -v bun || true) $(bun --version 2>/dev/null || true)"
              break
            else
              echo "installer attempt $i failed; retrying in 3s"
              sleep 3
            fi
          done

          # Ensure the binary is discoverable right now, after we exported the
          # path and attempted to source the profile.
          if ! command -v bun >/dev/null 2>&1; then
            echo "bun is still not available after retries" >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run prepare-functions
        run: bun run scripts/build/prepare-functions/prepare-functions.ts

      - name: Validate dist/functions imports
        run: npm run check:functions-dist-imports
